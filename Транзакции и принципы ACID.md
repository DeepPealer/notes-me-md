tags: [sql, postgresql, database, acid, transactions, interviewprep]  
alias: [Транзакции, ACID, Изоляция транзакций]  
related: [[SQL]], [[Базы данных]], [[Уровни изоляции транзакций]], [[Индексы и оптимизация запросов]]

**Транзакция** — это последовательность из одной или нескольких SQL-операций, которые выполняются как **единая логическая единица работы**. Главный принцип транзакции: **"всё или ничего"**. Либо все операции внутри неё успешно завершаются, либо, в случае сбоя, система возвращается в состояние, в котором она была до начала транзакции.

**Классическая аналогия**: банковский перевод.

1. Снять 100$ со счета А.
    
2. Добавить 100$ на счет Б.
    

Эти две операции должны быть выполнены как одна транзакция. Недопустима ситуация, когда деньги снялись со счета А, но не зачислились на счет Б из-за сбоя.

### Управление транзакциями в PostgreSQL

- BEGIN или START TRANSACTION: Начинает новую транзакцию.
    
- COMMIT: Успешно завершает транзакцию, делая все её изменения постоянными.
    
- ROLLBACK: Откатывает транзакцию, отменяя все изменения, сделанные с момента её начала.
```SQL
BEGIN; -- Начинаем транзакцию

UPDATE accounts SET balance = balance - 100 WHERE name = 'Alice';
UPDATE accounts SET balance = balance + 100 WHERE name = 'Bob';

-- На этом этапе изменения видны только внутри нашей транзакции.
-- Если сейчас произойдет сбой, или мы выполним ROLLBACK,
-- балансы останутся прежними.

COMMIT; -- Фиксируем изменения. Теперь они постоянны и видны всем.
```

## Принципы ACID

ACID — это акроним, описывающий четыре свойства, которые гарантирует транзакционная система для обеспечения надежности данных.

### 1. [[Atomicity (Атомарность)]]

- **Что это?** "Всё или ничего". Транзакция является неделимой (атомарной). Она либо выполняется полностью, либо не выполняется вообще. Не может быть частичного выполнения.
    
- **Аналогия**: Банковский перевод. Деньги не могут "повиснуть в воздухе".
    
- **Почему важно?** Защищает от неполных обновлений и повреждения данных. Если в середине сложной операции происходит сбой, база данных не останется в противоречивом, полуобновленном состоянии.
    

### 2. [[Consistency (Согласованность)]]

- **Что это?** Транзакция переводит базу данных из одного **корректного (согласованного) состояния** в другое. Система гарантирует, что после завершения транзакции все правила и ограничения (constraints) базы данных (NOT NULL, CHECK, FOREIGN KEY) будут соблюдены.
    
- **Аналогия**: Общая сумма денег в банке до и после перевода между счетами остается неизменной.
    
- **Почему важно?** Обеспечивает целостность и осмысленность данных. Нельзя, например, добавить заказ для несуществующего клиента, если есть FOREIGN KEY constraint. Если транзакция нарушает такое правило, она будет автоматически отменена (ROLLBACK).
    

### 3. [[Isolation (Изолированность)]]

- **Что это?** Параллельно выполняемые транзакции не должны мешать друг другу. С точки зрения одной транзакции, кажется, что в данный момент времени никакие другие транзакции в системе не выполняются.
    
- **Аналогия**: Два кассира в банке работают с разными клиентами. Кассир А не видит промежуточные, не зафиксированные операции кассира Б.
    
- **Почему важно?** Предотвращает проблемы параллельного доступа, такие как "грязные чтения" (чтение не зафиксированных данных) или "потерянные обновления".
    
- **Важный нюанс**: Это единственный "гибкий" принцип. В SQL существуют [[Уровни изоляции транзакций]], которые позволяют ослабить строгость изоляции ради повышения производительности.
    

### 4. [[Durability (Стойкость / Долговечность)]]

- **Что это?** Если транзакция была успешно завершена (COMMIT), её результаты являются постоянными и не будут потеряны даже в случае сбоя системы (например, отключения питания).
    
- **Аналогия**: Если банкомат выдал чек "Операция успешна", деньги точно зачислены, и это не изменится.
    
- **Почему важно?** Гарантирует, что данные, которые система подтвердила как сохраненные, действительно сохранены. В PostgreSQL это достигается с помощью механизма **Write-Ahead Logging (WAL)**. Сначала все изменения записываются в журнал на диске, и только потом применяются к файлам данных.
    

---

### [[Savepoints (Точки сохранения)]]

Savepoint — это специальная метка внутри транзакции, которая позволяет откатиться не ко всему началу транзакции, а только к этой точке.

```SQL
BEGIN;
INSERT INTO my_table VALUES (1);

SAVEPOINT my_savepoint; -- Устанавливаем точку сохранения

INSERT INTO my_table VALUES (2);
ROLLBACK TO SAVEPOINT my_savepoint; -- Откатываемся к точке (INSERT...2 отменен)
INSERT INTO my_table VALUES (3);

COMMIT; -- В итоге в таблице будут строки 1 и 3.
```

### Популярные вопросы на собеседовании

- **"Расшифруйте ACID и объясните каждый принцип своими словами."**
    
- **"В чем разница между Атомарностью и Согласованностью?"**
    
    - Ответ: Атомарность — это механическое свойство "все или ничего". Согласованность — это логическое свойство, гарантирующее, что данные остаются верными с точки зрения бизнес-правил (constraints). Транзакция может быть атомарной (успешно выполнилась целиком), но несогласованной (нарушила какое-то правило, из-за чего система сама сделает ROLLBACK).
        
- **"Какой из принципов ACID можно "настраивать" и почему?"**
    
    - Ответ: Изоляция. СУБД предоставляют разные уровни изоляции (READ COMMITTED, SERIALIZABLE и др.), которые предлагают компромисс между строгостью гарантий и производительностью системы при параллельной работе.