tags: [data-engineering, database, nosql, mongodb, scalability, sharding, interviewprep]  
alias: [Шардирование, Шардинг, Горизонтальное масштабирование]  
related: [[Data Replication]], [[NoSQL Concepts and CAP Theorem]], [[MapReduce and Massively Parallel Processing (MPP)]]

**Шардирование** — это метод **горизонтального масштабирования** базы данных. Он заключается в **разделении** большого набора данных на более мелкие части, называемые **шардами (shards)**, и распределении этих шардов по нескольким серверам (узлам).

> **Основная идея**: Вместо того чтобы хранить все данные на одном мощном сервере ([[Вертикальное масштабирование]]), мы распределяем и данные, и нагрузку по множеству более дешевых серверов.

**Аналогия**:

- [[Data Replication|Репликация]] — это **копирование** всей энциклопедии в несколько библиотек.
    
- **Шардирование** — это **разрезание** энциклопедии на тома (А-Д, Е-К, Л-П, ...) и отправка каждого тома в отдельную библиотеку.
    

### Проблема, которую решает шардирование

Шардирование решает проблему **масштабирования записи (write scaling)**.

- [[Data Replication|Репликация]] отлично помогает масштабировать чтение, но каждая запись все равно должна пройти через один основной сервер, который становится "бутылочным горлышком".
    
- При шардировании запросы на запись распределяются между разными шардами, что позволяет системе обрабатывать гораздо большую нагрузку.
    

---

### Ключевые компоненты шардированного кластера (на примере MongoDB)

1. **Шард (Shard)**
    
    - Это отдельный сервер (или, для надежности, [[Data Replication|реплика-сет]]), который хранит **часть** общих данных.
        
2. **Маршрутизатор запросов (Query Router / Mongos)**
    
    - Это "входная точка" для клиентских приложений. Маршрутизатор принимает запросы, смотрит на **ключ шарда**, определяет, на каком шарде находятся нужные данные, и направляет запрос туда.
        
    - Его задача — скрыть сложность шардирования от приложения.
        
3. **Серверы конфигурации (Config Servers)**
    
    - Это "мозг" кластера. Они хранят **метаданные** о том, какие данные на каком шарде лежат. Маршрутизаторы кэшируют эту информацию, чтобы быстро принимать решения.
        

---

### Выбор ключа шардирования (Shard Key) — **самое важное решение**

**Ключ шардирования** — это поле (или несколько полей) в документе, которое используется для определения, на какой шард этот документ попадет. Выбор правильного ключа — это критически важное решение, которое влияет на всё: производительность, масштабируемость и равномерность распределения данных.

**Характеристики хорошего ключа:**

- **Высокая кардинальность (High Cardinality)**: Ключ должен иметь много уникальных значений. Плохой ключ — "пол" (всего 2-3 значения).
    
- **Низкая частота (Low Frequency)**: Ни одно значение ключа не должно встречаться слишком часто.
    
- **Неизменность (Non-Monotonic)**: Ключ не должен монотонно возрастать или убывать (как timestamp или _id по умолчанию). Это приводит к тому, что все новые записи попадают на один и тот же "горячий" шард.
    

### Стратегии шардирования

1. **Hashed Sharding (Хешированное шардирование)**
    
    - **Как работает?** Система вычисляет хеш от значения ключа шарда и распределяет данные на основе этого хеша.
        
    - **(+) Плюсы**: Гарантирует **равномерное распределение** записей по всем шардам. Идеально подходит для write-heavy нагрузок.
        
    - **(-) Минусы**: Запросы по диапазону ключей (range queries) становятся неэффективными, так как связанные по смыслу данные (например, заказы за один день) оказываются на разных шардах. Системе приходится опрашивать все шарды.
        
2. **Ranged Sharding (Диапазонное шардирование)**
    
    - **Как работает?** Система делит весь диапазон значений ключа на непрерывные отрезки (chunks) и распределяет их по шардам. Например, шард 1 хранит пользователей с именами от 'A' до 'F', шард 2 — от 'G' до 'M' и т.д.
        
    - **(+) Плюсы**: Очень эффективно для **запросов по диапазону**.
        
    - **(-) Минусы**: Риск создания "горячего шарда" ("hotspot"). Если ключ шардирования — это дата, все новые записи будут писаться только на последний шард.
        

---

### Сводное сравнение стратегий

|   |   |   |
|---|---|---|
|Характеристика|Hashed Sharding (по хешу)|Ranged Sharding (по диапазону)|
|**Распределение данных**|**Равномерное**|Неравномерное (риск hotspot)|
|**Эффективность записи**|**Высокая**|Может быть низкой из-за hotspot|
|**Эффективность чтения по диапазону**|Низкая (опрос всех шардов)|**Высокая**|
|**Основной сценарий**|Равномерная нагрузка на запись|Частые запросы по диапазонам|

---

### Популярные вопросы на собеседовании

- **"Что такое шардирование и какую проблему оно решает, в отличие от репликации?"**
    
    - Ответ: Шардирование — это разделение данных на части для горизонтального масштабирования **записи**. Репликация — это копирование данных для обеспечения высокой доступности и масштабирования **чтения**.
        
- **"Почему выбор ключа шардирования так важен?"**
    
    - Ответ: От него зависит, насколько равномерно будут распределены данные и нагрузка по кластеру. Неправильный ключ может привести к появлению "горячих шардов", которые сведут на нет все преимущества масштабирования.
        
- **"Опишите две основные стратегии шардирования и их плюсы и минусы."**
    
- **"В чем проблема использования монотонно возрастающего поля (например, timestamp) в качестве ключа для диапазонного шардирования?"**
    
    - Ответ: Все новые записи будут попадать на один и тот же шард, создавая "hotspot" и перегружая его, в то время как остальные шарды будут простаивать.