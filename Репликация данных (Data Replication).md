tags: [data-engineering, database, postgresql, high-availability, devops, interviewprep]  
alias: [Репликация данных, Data Replication, Postgres Replication, High Availability]  
related: [[Базы данных]], [[Транзакции и принципы ACID]], [[OLAP vs OLTP]], [[Оптимизация запросов в SQL]]

**Репликация данных** — это процесс создания и поддержания точных копий (реплик) базы данных на других серверах.

**Главные цели репликации:**

1. **Высокая доступность (High Availability, HA)**: Если основной (Primary) сервер выходит из строя, одна из реплик может быстро стать новым основным сервером, минимизируя время простоя.
    
2. **Масштабирование чтения (Read Scaling)**: Нагрузка на чтение может быть распределена между несколькими репликами, что снижает нагрузку на основной сервер и ускоряет SELECT-запросы для клиентов.
    
3. **Аварийное восстановление (Disaster Recovery, DR)**: Реплика может находиться в другом географическом регионе. Если весь дата-центр с основным сервером отключается, данные остаются в сохранности.
    

### Как работает репликация в PostgreSQL

В основе большинства видов репликации в PostgreSQL лежит механизм **Write-Ahead Logging (WAL)**.

- Любое изменение в базе данных (INSERT, UPDATE, DELETE) сначала записывается в специальный журнал транзакций — WAL.
    
- **Основной сервер (Primary)** отправляет эти записи WAL на **серверы-реплики (Replicas/Standby)**.
    
- Реплики читают эти записи и применяют те же самые изменения к своей копии данных, тем самым оставаясь в синхронизированном состоянии.
    

---

### Основные типы репликации в PostgreSQL

#### 1. [[Физическая репликация (Physical Replication)]]

- **Идея**: Реплика является **побайтовой копией** основного сервера. Это наиболее распространенный тип, также известный как **потоковая репликация (Streaming Replication)**.
    
- **Механизм**: Основной сервер "стримит" (потоково передает) записи WAL на реплики.
    
- **Аналогия**: Ксерокс. Вы получаете точную, идентичную копию оригинала.
    
- **Использование**: Идеально для создания **"горячего резерва" (Hot Standby)**, который может немедленно взять на себя роль основного, или для создания **Read Replicas** для масштабирования чтения.
    
- **Ограничения**:
    
    - Реплицируется вся база данных целиком, нельзя выбрать одну таблицу.
        
    - Основной сервер и реплики должны быть одной и той же основной версии PostgreSQL.
        

#### 2. [[Логическая репликация (Logical Replication)]]

- **Идея**: Реплицируются не физические изменения, а **логические**. Реплика получает поток команд, таких как "вставить эту строку", "обновить эту строку".
    
- **Механизм**: Использует модель **"Издатель-Подписчик" (Publisher/Subscriber)**. Вы определяете, какие таблицы "публикуются", а реплики на них "подписываются".
    
- **Аналогия**: Подписка на журнал. Вы получаете новые выпуски (логические изменения), но не копию всей типографии.
    
- **Преимущества**:
    
    - **Гибкость**: Можно реплицировать отдельные таблицы или даже фильтровать строки.
        
    - Можно реплицировать данные между разными основными версиями PostgreSQL.
        
    - Можно реплицировать данные в другие системы (например, через плагины, в [[Apache Kafka]]).
        
- **Недостатки**: Более сложная настройка и выше накладные расходы по сравнению с физической репликацией.
    

---

### Асинхронная vs. Синхронная репликация

Это **ключевой компромисс** между производительностью и надежностью.

#### [[Асинхронная репликация (Asynchronous)]] — **По умолчанию**

- **Как работает**: Основной сервер выполняет COMMIT транзакции **не дожидаясь** ответа от реплики. Он просто отправляет WAL и продолжает работать.
    
- **(+) Плюсы**: **Высокая производительность**. Запись на основном сервере не замедляется из-за репликации.
    
- **(-) Минусы**: **Риск потери данных**. Если основной сервер выйдет из строя до того, как последняя транзакция будет доставлена на реплику, эта транзакция будет потеряна. Возникает **"лаг репликации" (replication lag)**.
    

#### [[Синхронная репликация (Synchronous)]]

- **Как работает**: Основной сервер **ждет подтверждения** как минимум от одной реплики, что она получила и сохранила запись WAL, и только после этого возвращает клиенту COMMIT.
    
- **(+) Плюсы**: **Гарантия отсутствия потерь данных** (для подтвержденных транзакций).
    
- **(-) Минусы**: **Снижение производительности**. Время выполнения транзакции на запись увеличивается, так как включает в себя сетевую задержку до реплики и обратно. Если синхронная реплика недоступна, основной сервер будет "висеть".
    

---

### Сводное сравнение

|   |   |   |
|---|---|---|
|Характеристика|Асинхронная репликация|Синхронная репликация|
|**Гарантия данных**|Возможна потеря данных (небольшая)|Нулевая потеря данных (Zero Data Loss)|
|**Производительность**|**Высокая**|**Низкая** (зависит от сети)|
|**Надежность Primary**|Не зависит от состояния реплик|Зависит от доступности реплик|
|**Основной сценарий**|Масштабирование чтения, теплый резерв|Критически важные финансовые системы|

---

### Популярные вопросы на собеседовании

- **"Зачем нужна репликация баз данных?"**
    
- **"Объясните разницу между физической и логической репликацией."**
    
- **"Что такое лаг репликации (replication lag) и в каком режиме он возникает?"**
    
    - Ответ: Это задержка, с которой изменения с основного сервера применяются на реплике. Он возникает при асинхронной репликации.
        
- **"Опишите компромисс между синхронной и асинхронной репликацией."**
    
    - Ответ: Это компромисс между производительностью и гарантией сохранности данных. Асинхронная — быстрая, но с риском потери. Синхронная — медленная, но без риска потери.
        
- **"Что такое 'read replica' и какую проблему она решает?"**
    
    - Ответ: Это реплика (обычно созданная с помощью физической репликации), предназначенная для обработки SELECT-запросов. Она решает проблему масштабирования чтения, снимая эту нагрузку с основного сервера.
        

---
