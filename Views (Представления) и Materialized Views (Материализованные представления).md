tags: [sql, postgresql, database, bigdata, interviewprep, optimization]  
alias: [View, Представление, Materialized View, Материализованное представление, Вьюха]  
related: [[SQL]], [[SELECT запросы в SQL]], [[Оптимизация запросов в SQL]]

Представление — это, по сути, **сохраненный в базе данных именованный SELECT запрос**. Оно ведет себя как "виртуальная таблица", к которой можно обращаться так же, как и к обычной.

**Основные цели использования представлений:**

1. **Упрощение (Абстракция)**: Скрыть сложные [[JOINs]] и вычисления за простым именем. Аналитику не нужно каждый раз писать длинный запрос, он просто делает SELECT * FROM my_awesome_view.
    
2. **Безопасность**: Предоставить пользователям доступ не ко всей таблице, а только к определенным столбцам или строкам, которые разрешены для просмотра.
    
3. **Совместимость**: Поддерживать обратную совместимость, если вы меняете схему базовых таблиц.

## [[View]] (Обычное или простое представление)

**Идея**: VIEW — это **виртуальная** таблица. Она **не хранит никаких данных** физически. Это просто псевдоним для запроса.

**Как это работает?** Каждый раз, когда вы делаете SELECT из обычного представления, система управления базами данных (СУБД) **заново выполняет** тот SELECT запрос, который был определен при создании этого представления.

**Синтаксис:**
```SQL
CREATE VIEW it_and_hr_employees AS
    SELECT name, department_id
    FROM employees
    WHERE department_id IN (1, 2);

-- Теперь можно делать так:
SELECT * FROM it_and_hr_employees;
-- ...и это будет эквивалентно выполнению исходного запроса.
```

### Преимущества и недостатки VIEW

**(+) Плюсы:**

- **Всегда актуальные данные**: Так как запрос выполняется в реальном времени, вы всегда видите свежие данные из базовых таблиц.
    
- **Не занимает места**: В базе хранится только текст самого запроса, а не его результат.
    

**(-) Минусы:**

- **Производительность**: Если базовый SELECT запрос медленный (например, содержит сложные JOIN'ы на больших таблицах), то и запрос к представлению будет таким же медленным. Никакой магии не происходит.
    

**Когда использовать?**

- Для упрощения часто используемых запросов.
    
- Для разграничения прав доступа к данным (row-level и column-level security).
    
- Когда критически важна актуальность данных в реальном времени.
    

---

## [[Materialized View]] (Материализованное представление)

**Идея**: В отличие от обычного, материализованное представление — это **физическая** таблица, которая **хранит результат** выполнения SELECT запроса. Это "снимок" (snapshot) данных на определенный момент времени.

**Как это работает?** При создании материализованного представления запрос выполняется один раз, и его результат сохраняется на диск. Запросы SELECT к такому представлению выполняются очень быстро, так как они просто читают данные из уже готовой таблицы.

> **Главный нюанс**: Данные в материализованном представлении **не обновляются автоматически**. Они устаревают. Чтобы их обновить, нужно явно выполнить команду REFRESH.

**Синтаксис:**
```SQL
-- Создаем материализованное представление со сложной агрегацией
CREATE MATERIALIZED VIEW department_stats AS
    SELECT
        d.name AS department_name,
        COUNT(e.id) AS number_of_employees,
        AVG(e.salary) AS average_salary
    FROM departments d
    LEFT JOIN employees e ON d.id = e.department_id
    GROUP BY d.name;

-- Чтение данных происходит мгновенно
SELECT * FROM department_stats;

-- Чтобы обновить данные после изменений в таблицах employees или departments:
REFRESH MATERIALIZED VIEW department_stats;
```
### Преимущества и недостатки MATERIALIZED VIEW

**(+) Плюсы:**

- **Высокая производительность чтения**: Запросы к представлению выполняются очень быстро, так как все сложные вычисления уже сделаны заранее.
    

**(-) Минусы:**

- **Данные могут быть неактуальными**: Требуется периодический REFRESH.
    
- **Занимает место на диске**: Так как хранит реальные данные.
    
- **Процесс REFRESH может быть долгим и ресурсоемким** для больших объемов данных.
    

### Сводное сравнение

|                         |                                                    |                                                         |
| ----------------------- | -------------------------------------------------- | ------------------------------------------------------- |
| Характеристика          | VIEW (Представление)                               | MATERIALIZED VIEW (Материализованное представление)     |
| **Что это?**            | Виртуальная таблица (только запрос)                | Физическая таблица (результат запроса)                  |
| **Хранение данных**     | Не хранит данные                                   | Хранит данные на диске                                  |
| **Актуальность данных** | Всегда актуальны (real-time)                       | Устаревают, требуют REFRESH                             |
| **Производительность**  | Зависит от сложности базового запроса              | Очень высокая (как у обычной таблицы)                   |
| **Основной сценарий**   | Упрощение, безопасность, данные в реальном времени | Отчеты, аналитика, дашборды, ускорение "тяжелых" чтений |
### Популярные вопросы на собеседовании

- **"В чем ключевое различие между VIEW и MATERIALIZED VIEW?"**
    
    - Ответ: VIEW — это просто сохраненный запрос, он не хранит данные и всегда актуален, но может быть медленным. MATERIALIZED VIEW хранит результат запроса физически, поэтому он очень быстрый для чтения, но его данные могут устаревать и требуют ручного обновления через REFRESH.
        
- **"Вам нужно создать дашборд, который показывает ежедневную статистику продаж. Что вы будете использовать: VIEW или MATERIALIZED VIEW и почему?"**
    
    - Ответ: MATERIALIZED VIEW. Потому что дашборду не нужна ежесекундная актуальность, а запрос для расчета статистики может быть тяжелым. Мы можем создать материализованное представление и настроить его обновление (REFRESH) раз в день (например, ночью), чтобы пользователи получали быстрый отклик от дашборда.