tags: [nosql, database, bigdata, system-design, cap-theorem, interviewprep]  
alias: [NoSQL, CAP теорема, BASE]  
related: [[SQL]], [[Базы данных]], [[Распределенные системы]], [[Хеш-таблицы (Hash Tables)]]

**NoSQL** (часто расшифровывается как "Not Only SQL" — "Не только SQL") — это широкий класс систем управления базами данных, которые отличаются от традиционных реляционных [[SQL|SQL]] баз данных. Они появились в ответ на потребности современных веб-приложений и Big Data систем:

- **Огромные объемы данных**: Данные, которые не помещаются на один сервер.
    
- **Высокая скорость и доступность**: Необходимость обрабатывать тысячи запросов в секунду 24/7.
    
- **Гибкость схемы**: Работа с неструктурированными или полуструктурированными данными (например, JSON).
    

### Ключевые отличия NoSQL от SQL

|                         |                                                            |                                                                      |
| ----------------------- | ---------------------------------------------------------- | -------------------------------------------------------------------- |
| Характеристика          | SQL (Реляционные БД)                                       | NoSQL (Нереляционные БД)                                             |
| **Модель данных**       | Структурированная (таблицы с жесткой схемой)               | Гибкая (документы, ключ-значение, колонки, графы)                    |
| **Масштабирование**     | **Вертикальное** (Scale-up): покупаем более мощный сервер. | **Горизонтальное** (Scale-out): добавляем больше серверов (кластер). |
| **Гарантии транзакций** | **`[[Транзакции и принципы ACID                            | ACID]]`** (строгая согласованность)                                  |
| **Язык запросов**       | Стандартизированный SQL                                    | Различается для каждой БД (No-SQL = "нет SQL" как стандарта)         |

### Основные типы NoSQL баз данных

1. **Документные (Document Databases)**
    
    - **Идея**: Хранят данные в формате, похожем на JSON (в MongoDB это BSON). Каждая запись — это самостоятельный документ, содержащий всю информацию о себе.
        
    - **Аналогия**: Коллекция [[JSON]]-объектов.
        
    - **Примеры**: MongoDB, Couchbase.
        
    - **Когда использовать**: Веб-приложения, каталоги товаров, пользовательские профили.
        
2. **Ключ-значение (Key-Value Stores)**
    
    - **Идея**: Самая простая модель. Данные хранятся как в гигантской [[Хеш-таблицы (Hash Tables)|хеш-таблице]] или словаре.
        
    - **Аналогия**: Python dict.
        
    - **Примеры**: Redis, Amazon DynamoDB, Riak.
        
    - **Когда использовать**: Кэширование, хранение сессий, таблицы лидеров в играх.
        
3. **Колоночные (Column-Family Stores)**
    
    - **Идея**: Хранят данные по колонкам, а не по строкам. Это делает их невероятно быстрыми для аналитических запросов, которые затрагивают только небольшое подмножество колонок.
        
    - **Аналогия**: Таблица, повернутая на 90 градусов.
        
    - **Примеры**: Apache Cassandra, Apache HBase.
        
    - **Когда использовать**: Аналитика, обработка логов, IoT-данные, системы, где требуется высокая производительность на запись.
        
4. **Графовые (Graph Databases)**
    
    - **Идея**: Оптимизированы для хранения и обхода связей между данными. Вершины и ребра из [[Графы (Graphs)|теории графов]] являются объектами первого класса.
        
    - **Аналогия**: Социальная сеть.
        
    - **Примеры**: Neo4j, Amazon Neptune.
        
    - **Когда использовать**: Социальные сети, рекомендательные системы, системы обнаружения мошенничества.
        

---

## Теорема CAP (Теорема Брюера)

Теорема CAP — это фундаментальный принцип распределенных систем. Она гласит, что любая распределенная система хранения данных может одновременно обеспечивать **только два** из следующих трех свойств:

1. **[[Consistency (Согласованность)]] (C)**: **Строгая согласованность**. Любое чтение возвращает самые последние записанные данные или ошибку. Все узлы кластера в любой момент времени видят одни и те же данные.
    
2. **[[Availability (Доступность)]] (A)**: Любой запрос к системе получает ответ (не ошибку), даже если некоторые узлы неисправны. Система всегда "на связи".
    
3. **[[Partition Tolerance (Устойчивость к разделению)]] (P)**: Система продолжает работать, даже если связь между группами узлов ("партициями") нарушена (например, из-за проблем с сетью).
    

**Почему это важно?** В любой реальной распределенной системе мы **не можем пожертвовать P**. Проблемы с сетью неизбежны. Поэтому реальный выбор всегда стоит между **C** и **A**.

- **Системы CP (Consistency + Partition Tolerance)**: В случае сетевого сбоя система предпочтет **отказаться отвечать** (стать недоступной), чем вернуть несогласованные, устаревшие данные.
    
    - **Примеры**: HBase, MongoDB (в режиме по умолчанию).
        
    - **Используются**: В системах, где корректность данных критична: финансы, биллинг, e-commerce.
        
- **Системы AP (Availability + Partition Tolerance)**: В случае сетевого сбоя система предпочтет **остаться доступной** и ответить, даже если данные могут быть немного устаревшими.
    
    - **Примеры**: Cassandra, DynamoDB, CouchDB.
        
    - **Используются**: В системах, где доступность важнее строгой согласованности: ленты социальных сетей, аналитика посещений, где потеря нескольких событий не критична.
        

---

## От ACID к BASE

Если SQL-базы строятся на принципах [[Транзакции и принципы ACID|ACID]], то большинство NoSQL-систем (особенно AP-типа) строятся на принципах **BASE**:

- **B**asically **A**vailable (В основном доступна): Система гарантирует доступность (A из CAP).
    
- **S**oft State (Гибкое состояние): Состояние системы может меняться со временем даже без нового ввода из-за распространения обновлений.
    
- **E**ventual Consistency (Согласованность в конечном счете): Система **в конечном итоге** придет к согласованному состоянию, если прекратить вносить в нее изменения. На какой-то промежуток времени разные узлы могут содержать разные версии данных.
    

---

### Популярные вопросы на собеседовании

- **"Расскажите о теореме CAP. Какой выбор она ставит перед разработчиками распределенных систем?"**
    
    - Ответ: Она говорит, что из трех свойств (Согласованность, Доступность, Устойчивость к разделению) можно выбрать только два. Так как Устойчивость к разделению в сети обязательна, реальный выбор стоит между Согласованностью (CP) и Доступностью (AP).
        
- **"Что такое Eventual Consistency?"**
    
    - Ответ: Это модель согласованности, которая гарантирует, что если в систему не поступают новые обновления, то в конечном итоге все реплики данных станут согласованными. Это компромисс, на который идут AP-системы, чтобы оставаться доступными во время сетевых сбоев.
        
- **"Приведите пример, когда вы выберете SQL, а когда NoSQL базу данных для нового проекта."**
    
    - Ответ: Я выберу SQL для системы, где требуется строгая целостность данных и транзакционность (например, банковское приложение), а данные хорошо структурированы. Я выберу NoSQL (например, Cassandra) для системы, которая должна обрабатывать огромный поток данных с высокой производительностью на запись и где горизонтальное масштабирование и доступность важнее строгой согласованности (например, сбор логов или IoT-данных).